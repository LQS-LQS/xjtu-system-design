

# <center>è®¡ç®—æœºç³»ç»Ÿç»¼åˆè®¾è®¡å®éªŒæŠ¥å‘Š</center>

æ„Ÿè°¢æ¾³å“¥å¸®åŠ©ğŸ˜‹ğŸ§¡

`Ubuntu`ç‰ˆæœ¬ï¼š18.04(è€å¸ˆå‘çš„æŒ‡å¯¼ä¹¦ä¸Šè¯´ç”¨`Ubuntu20.04`å‡ºç°äº†é—®é¢˜)

| ç­çº§     | å§“å   | å­¦å·       |
| -------- | ------ | ---------- |
| è®¡ç®—æœº91 | åˆ˜é’å¸… | 2191211634 |

è¯´æ˜ï¼šå¦‚æœæŒ‰ç…§ä¸‹é¢çš„ä¸€æ­¥ä¸€æ­¥æ¥ï¼Œåº”è¯¥ä¸ä¼šå‡ºç°é—®é¢˜(ç»ç‹å§æ£€éªŒï¼Œæ˜¯è¿™æ ·çš„)

<hr style="background-color:red; height:5px">

æˆ‘æ–°å»ºäº†ä¸€ä¸ª`Desktop`æ–‡ä»¶å¤¹ï¼ŒDesktopå’Œæ¡Œé¢æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„æ–‡ä»¶å¤¹ï¼Œä½ å¦‚æœçœ‹åˆ°ç›®å½•æœ‰<font color=red>æ¡Œé¢</font>è¿™æ ·çš„å­—çœ¼ï¼Œè¿™æ˜¯æˆ‘ä¹‹å‰åšçš„ï¼Œæˆªå›¾å¿˜æ”¹äº†ã€‚(è¿™é‡Œå»ºè®®ç”¨è‹±æ–‡è·¯å¾„ï¼Œç”¨ä¸­æ–‡çš„**æ¡Œé¢**å…¶å®ä¹Ÿæ²¡é—®é¢˜ï¼Œå°±æ˜¯åé¢ä¿®æ”¹ä¸€ä¸ªè·¯å¾„çš„æ—¶å€™`configmenu`æ— æ³•è¾“å…¥ä¸­æ–‡ï¼Œéœ€è¦`vim`è¾“å…¥ä¸­æ–‡)


![image-20220606134732391](./imgs/image-20220606134732391.png)

`Desktop`ç›®å½•ä¸‹æ–°å»º`cross`æ–‡ä»¶å¤¹å’Œ`arm`æ–‡ä»¶å¤¹

![image-20220606134839604](./imgs/image-20220606134839604.png)

`cross`çš„ç›®å½•å¦‚ä¸‹ï¼ˆå…ˆçœ‹ä¸€ä¸‹å°±è¡Œï¼Œé˜²æ­¢åé¢ä¹±ï¼Œä½ å¯ä»¥å›çœ‹ä¸€ä¸‹ï¼‰

![image-20220606134904148](./imgs/image-20220606134904148.png)

<hr style="background-color:red; height:5px">

## ä¸€ã€ é¢å‘é£è…¾å¤„ç†å™¨ç¼–è¯‘Linuxå†…æ ¸å’ŒåŸºæœ¬å·¥å…·

æå‰å®‰è£…ä¸‹é¢ä¸œè¥¿ï¼Œé˜²æ­¢å‡ºé”™

```
sudo apt-get install make qemu-system-arm gcc-arm-linux-gnueabi libncurses5-dev bison flex vim gcc g++ build-essential
```

### 1.1å®éªŒç›®çš„

åˆ©ç”¨`QEMU`åˆ›å»ºé£è…¾ï¼ˆ`ARM`ï¼‰ æ¶æ„è®¡ç®—æœºï¼Œåœ¨æ­¤ä¹‹ä¸Šç¼–è¯‘ä¸€ä¸ªåŸºæœ¬çš„`Linux`æ“ä½œç³»ç»Ÿ

### 1.2å®éªŒæ­¥éª¤

å…ˆä¸‹è½½å¥½`busybox`å’Œ`linux`å†…æ ¸çš„æºç ï¼Œå¹¶è§£å‹

ä¸‹è½½`busybox`

```
wget https://busybox.net/downloads/busybox-1.31.1.tar.bz2
```

è°·æ­Œæœç´¢`linux-4.19.86`è‡ªå·±ä¸‹è½½

![image-20220604120227024](./imgs/image-20220604120227024.png)

ä¸‹è½½å¹¶è§£å‹å¥½ä¹‹å(å³é”®å‹ç¼©çš„æ–‡ä»¶ï¼Œæ‰‹åŠ¨æå–åˆ°å½“å‰ç›®å½•å°±è¡Œ)

<div align="center">
    <img src="./imgs/image-20220605222308009.png">
    <img src="./imgs/image-20220605222315991.png">
</div>
`cd`åˆ°è§£å‹åçš„`busybox`çš„ç›®å½•é‡Œé¢ï¼Œæ‰§è¡Œä¸‹é¢ä¸‰ä¸ªæŒ‡ä»¤ï¼Œ

<font color=red>å…¶ä¸­ç¬¬ä¸€ä¸ªå‡ºç°menuåªéœ€è¦é€€å‡ºå°±è¡Œï¼Œé‡Œé¢å·²ç»å‹¾é€‰äº†é»˜è®¤çš„å‚æ•°  </font>

ä¸Šé¢æ˜¯æŒ‡å¯¼ä¹¦ä¸Šçš„è¯´çš„ï¼Œä¸è¦è¿™æ ·å¹²ï¼Œåƒä¸‡ä¸è¦ç›´æ¥é€€å‡ºï¼Œè¦æŠŠä¸‹é¢çš„**Build static binary**å‹¾é€‰ä¸Šï¼ï¼ï¼

```
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- menuconfig
	ä¸€å®šæ³¨æ„æŠŠè¿™ä¸ªé€‰ä¸Š  é€‰ä¸­Settings->Build static binary(no shared libs) (NEW) å¾€ä¸‹æ»‘æ»‘æ»‘
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- install
```

![image-20220604124542668](./imgs/image-20220604124542668.png)

![image-20220605131620681](./imgs/image-20220605131620681.png)

![image-20220604132104061](./imgs/image-20220604132104061.png)

ä¸Šé¢3ä¸ªmakeæŒ‡ä»¤å®Œæ¯•åï¼Œåœ¨`_install`ç›®å½•ä¸‹ç”Ÿæˆä¸€äº›æ–‡ä»¶,åˆ›å»ºä¸‹åˆ—æ–‡ä»¶å¤¹å¤‡ç”¨ï¼š etc proc sys tmp dev lib  

```
mkdir etc proc sys tmp dev lib
```

![image-20220605131917162](./imgs/image-20220605131917162.png)

![image-20220606135218455](./imgs/image-20220606135218455.png)

`dev`ç›®å½•ä¸‹é™æ€åˆ›å»ºå¦‚ä¸‹èŠ‚ç‚¹ï¼š  

```
sudo mknod -m 666 tty1 c 4 1
sudo mknod -m 666 tty2 c 4 2
sudo mknod -m 666 tty3 c 4 3
sudo mknod -m 666 tty4 c 4 4
sudo mknod -m 666 console c 5 1
sudo mknod -m 666 null c 1 3
```

![image-20220605132022850](./imgs/image-20220605132022850.png)

![image-20220606135249109](./imgs/image-20220606135249109.png)

å‘`_install/etc`ç›®å½•æ–°å»º`inittab`æ–‡ä»¶ã€`fstab`æ–‡ä»¶(è¿™æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ²¡æœ‰åç¼€)

```
touch inittab fstab
```

ä½¿ç”¨`vim`å†™å…¥æ–‡ä»¶

`inittab`æ–‡ä»¶å¦‚ä¸‹

```
::sysinit:/etc/init.d/rcS
::askfirst:/bin/sh
::ctrlaltdel:/sbin/reboot
::shutdown:/sbin/swapoff -a
::shutdown:/bin/umount -a -r
::restart:/sbin/init
tty2::askfirst:/bin/sh
tty3::askfirst:/bin/sh
tty4::askfirst:/bin/sh
```

`fstab`æ–‡ä»¶å¦‚ä¸‹

```
#device mount-point type option dump fsck order
proc  /proc proc  defaults 0 0
temps /tmp  rpoc  defaults 0 0
none  /tmp  ramfs defaults 0 0
sysfs /sys  sysfs defaults 0 0
mdev  /dev  ramfs defaults 0 0
```

å‘`etc`ç›®å½•æ–°å»º`init.dæ–‡ä»¶å¤¹`ï¼Œåœ¨`init.dæ–‡ä»¶å¤¹`ä¸‹æ–°å»º`rcSæ–‡ä»¶`

```
mkdir init.d
cd ./init.d
touch rcS
```

`rcS`æ–‡ä»¶å¦‚ä¸‹

```
mount -a
echo "/sbin/mdev" > /proc/sys/kernel/hotplug
/sbin/mdev -s
mount -a
```

ç„¶åä¸€å®šè¦ä¿®æ”¹`rcS`æ–‡ä»¶çš„æƒé™

```
chmod +x rcS
```

![image-20220605140207089](./imgs/image-20220605140207089.png)

æŠŠä¾èµ–çš„åº“æ–‡ä»¶æ‹·è´åˆ°`_install/lib/`ç›®å½•ä¸‹ (å¦‚ä¸‹)

`busybox`ç›®å½•ä¸‹æœç´¢`modules`æ–‡ä»¶å¤¹ï¼Œå…¨å±€æœç´¢ä¸‹é¢æ–‡ä»¶ï¼Œå‡æ‹·è´åˆ°`_install/lib`ç›®å½•ä¸‹

![image-20220604142703843](./imgs/image-20220604142703843.png)

![image-20220604142253582](./imgs/image-20220604142253582.png)

![image-20220604142053361](./imgs/image-20220604142053361.png)

![image-20220604142151676](./imgs/image-20220604142151676.png)

![image-20220604142441160](./imgs/image-20220604142441160.png)

ç»“æœå¦‚ä¸‹

![image-20220604143657637](./imgs/image-20220604143657637.png)

æ¥ä¸‹æ¥ç¼–è¯‘`linux`å†…æ ¸ï¼ˆåœ¨è§£å‹çš„`linux`ç›®å½•ä¸‹`make`ï¼‰ï¼Œç¬¬äºŒæ­¥æ—¶é—´å¾ˆé•¿ï¼Œä½ å¯ä»¥å·ç€ä¹

```
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- vexpress_defconfig
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-
```

æ­¤æ—¶`boot`ç›®å½•å¦‚ä¸‹

![image-20220605225123337](./imgs/image-20220605225123337.png)

å†è¿›è¡Œå¦‚ä¸‹æ­¥éª¤ï¼ˆåœ¨`linux`ç›®å½•ä¸‹makeï¼‰

```
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- modules_install INSTALL_MOD_PATH="/home/liuqingshuai/Desktop/cross/busybox-1.31.1/_install/"
```

![image-20220605225147103](./imgs/image-20220605225147103.png)

`Desktop`ä¸Šåˆ›å»ºä¸€ä¸ª`arm`æ–‡ä»¶å¤¹ï¼Œç„¶ååœ¨`arm`ç›®å½•ä¸‹æ‰§è¡Œä¸‹é¢æ­¥éª¤

```
dd if=/dev/zero of=rootfs.ext3 bs=1M count=32
mkfs.ext3 rootfs.ext3
sudo mount -o loop rootfs.ext3 /tmp
sudo cp -a /home/liuqingshuai/Desktop/cross/busybox-1.31.1/_install/* /tmp
sudo umount /tmp
```

![image-20220605125937184](./imgs/image-20220605125937184.png)

å°†`/home/liuqingshuai/Desktop/cross/linux-4.19.86/arch/arm/boot`çš„`zImage`æ‹·è´åˆ°armç›®å½•ä¸‹

å°†`/home/liuqingshuai/Desktop/cross/linux-4.19.86/arch/arm/boot/dts`çš„`vexpress-v2p-ca9.dtb`æ‹·è´åˆ°`arm`ç›®å½•ä¸‹

![image-20220605130043222](./imgs/image-20220605130043222.png)

åœ¨`arm`ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤

```
qemu-system-arm -M vexpress-a9 -kernel ./zImage -nographic -m 512M -smp 4 -sd ./rootfs.ext3 -dtb vexpress-v2p-ca9.dtb -append "init=/linuxrc root=/dev/mmcblk0 rw rootwait earlyprintk console=ttyAMA0"
```

![image-20220606135512178](./imgs/image-20220606135512178.png)

![image-20220605140434509](./imgs/image-20220605140434509.png)

ç”¨å‡ ä¸ªå‘½ä»¤æµ‹è¯•ä¸€ä¸‹

![image-20220605140455617](./imgs/image-20220605140455617.png)

è‡³æ­¤ï¼Œå®éªŒå®Œäº†

### 1.3å®éªŒç»“æœ

æœ¬æ¬¡å®éªŒåˆ©ç”¨`qemu`åˆ›å»ºé£è…¾æ¶æ„è®¡ç®—æœºï¼Œåœ¨æ­¤ä¹‹ä¸Šç¼–è¯‘ä¸€ä¸ªåŸºæœ¬çš„`Linux`æ“ä½œç³»ç»Ÿï¼Œé€šè¿‡`Busybox`æ„å»ºäº†åŸºæœ¬çš„ç³»ç»Ÿå‘½ä»¤ã€‚  

## äºŒã€é¢å‘é£è…¾å¤„ç†å™¨çš„äº¤å‰ç¼–è¯‘ç¯å¢ƒ

æå‰å®‰è£…ï¼Œé˜²æ­¢å‡ºé”™

```
sudo apt-get install autoconf automake libtool libncurses5-dev gperf texinfo help2man gawk libtool-bin
```

### 2.1å®éªŒç›®çš„

åˆ©ç”¨`crosstool`åˆ¶ä½œä¸€ä¸ªäº¤å‰ç¼–è¯‘å·¥å…·é“¾ï¼Œä½¿å…¶èƒ½äº¤å‰ç¼–è¯‘cæºæ–‡ä»¶ï¼Œ ç”Ÿæˆé£è…¾å¹³å°ä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶

### 2.2 å®éªŒæ­¥éª¤

ä¸‹è½½`crosstool`å‹ç¼©åŒ…ç„¶åå‹ç¼©åŒ…å³é”®æå–ä¸€ä¸‹

```
wget http://crosstool-ng.org/download/crosstool-ng/crosstool-ng-1.24.0.tar.bz2
```


å’Œ`crosstool-ng-1.24.0`å¹¶åˆ—å…³ç³»åˆ›å»º`crosstool-build`ï¼Œ`crosstool-install`ï¼Œ`src`ã€`x-tools`æ–‡ä»¶å¤¹


```
mkdir crosstool-build crosstool-install src x-tools
```

åœ¨`crosstool-ng-1.24.0`ç›®å½•ä¸‹ä¾æ¬¡æ‰§è¡Œ

```
./bootstrap
./configure --prefix /home/liuqingshuai/Desktop/cross/crosstool-install
make
sudo make install
```

è¿›å…¥`crosstool-install/bin`ç›®å½•ä¸‹æ‰§è¡Œ

```
./ct-ng
./ct-ng -v
```

![image-20220604204158752](./imgs/image-20220604204158752.png)

![image-20220604204312258](./imgs/image-20220604204312258.png)

`crosstool-install/bin`ç›®å½•ä¸‹å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ–‡ä»¶

![image-20220604204353089](./imgs/image-20220604204353089.png)

ç„¶åæ·»åŠ ä¸´æ—¶çš„ç¯å¢ƒå˜é‡ï¼ˆæ·»åŠ ä¸€ä¸‹`ct-ng`çš„æ–‡ä»¶å¤¹è·¯å¾„åˆ°`PATH`ä¸­ï¼Œæ–¹ä¾¿ä¹‹åè°ƒç”¨ï¼‰

`export PATH=$PATH:/home/liuqingshuai/Desktop/cross/crosstool-install/bin/`

ä¸‹é¢æ˜¯ç½‘ä¸Šè¯´çš„`export`ä½œç”¨

<hr style="background-color:red; height:5px">

![image-20220607155854095](./imgs/image-20220607155854095.png)

<hr style="background-color:red; height:5px">


`src`æ–‡ä»¶å¤¹æœ‰å¦‚ä¸‹å‹ç¼©åŒ…ï¼ˆè°·æ­Œæœä¸€ä¸‹ï¼Œä¸‹è½½ï¼‰ï¼Œå·¦ä¾§æˆªå›¾å¤šäº†å‡ ä¸ªä¸éœ€è¦çš„ï¼Œä»¥å³ä¾§ä¸ºå‡†ï¼ˆå½“ç„¶ï¼Œå¤šä¸‹è½½è‚¯å®šä¸ä¼šå‡ºé”™ï¼‰

<div>
  <img src="./imgs/image-20220606134057135.png" width="70%">
  <img src="./imgs/image-20220616135553003.png" width="28%">
</div>

åœ¨`crosstool-build`ç›®å½•ä¸‹æ‰§è¡Œ

```
ct-ng menuconfig
```

ç„¶ååšä¸‹è¿°ä¿®æ”¹

é€‰æ‹©`Paths and misc options`ï¼Œæ‰¾åˆ°`Working directory`å’Œ`Local tarballs directory`ä¿®æ”¹

è¿˜å¯ä»¥è®¾ç½®ä¸€ä¸‹`Number of parallel jobs`(å¹¶è¡Œä»»åŠ¡çš„æ•°é‡ï¼Œéå¿…è¦)

![image-20220606123523221](./imgs/image-20220606123523221.png)

![image-20220616135806721](./imgs/image-20220616135806721.png)

é€‰æ‹©`Target options`ï¼Œæ¶æ„é€‰`arm`ï¼Œ`Architecture level`å¡«å†™ä¸º`armv7-a`ï¼Œï¼ˆä½ çš„ç•Œé¢åº”è¯¥æœ‰ä¸€ä¸ª**ev4**ï¼ŒæŠŠè¿™ä¸ªå»æ‰æ‰èƒ½å‡ºç°`architecture level`ï¼‰

![image-20220606123024670](./imgs/image-20220606123024670.png)

![image-20220606123233929](./imgs/image-20220606123233929.png)

é€‰æ‹©`Operating System`ï¼Œ`Target OS`æ”¹ä¸º`linux`ï¼Œåé¢çš„ç‰ˆæœ¬å·ä¸ç”¨ç®¡ï¼Œä¹‹åä¼šæ‰‹åŠ¨ä¿®æ”¹

![image-20220609095032380](./imgs/image-20220609095032380.png)

ç¼–è¾‘`.config`(åœ¨`crosstool-build`ç›®å½•ä¸‹,`.config`æ–‡ä»¶é€šè¿‡`ls`çœ‹ä¸åˆ°ï¼Œéœ€è¦`ls -a`)(ä¸Šä¸€æ­¥`ct-ng menuconfig`ä¹‹åä¼šè‡ªåŠ¨ç”Ÿæˆ`.config`æ–‡ä»¶)

```
vim .config
```

ä¿®æ”¹`CT_GLIBC_MIN_KERNEL`ä¸º`4.19.86`

![image-20220606123709751](./imgs/image-20220606123709751.png)

`CT_LINUX_VERSION`ä¸º`4.19.86`

![image-20220606123756867](./imgs/image-20220606123756867.png)

åœ¨`crosstool-build`ä¸‹æ‰§è¡Œä¸‹é¢æŒ‡ä»¤ï¼ˆæ—¶é—´å¾ˆé•¿ï¼‰

```
ct-ng build
```

![image-20220604225211788](./imgs/image-20220604225211788.png)

![image-20220606112805595](./imgs/image-20220606112805595.png)

ç”Ÿæˆçš„`gcc`åœ¨å¦‚ä¸‹ç›®å½•`/home/liuqingshuai/Desktop/cross/x-tools/arm-unknown-linux-gnueabi/arm-unknown-linux-gnueabi/buildtools/bin`

![image-20220606133249168](./imgs/image-20220606133249168.png)

æµ‹è¯•ä¸€ä¸‹è¿™ä¸ª`gcc`çš„ç‰ˆæœ¬(åœ¨ä¸Šé¢é‚£ä¸ª`bin`ç›®å½•ä¸‹æµ‹è¯•)

```
./arm-unknown-linux-gnueabi-gcc --version
```

![image-20220606133325115](./imgs/image-20220606133325115.png)

`gcc`çš„ç»å¯¹ä½ç½®å¦‚ä¸‹`/home/liuqingshuai/Desktop/cross/x-tools/arm-unknown-linux-gnueabi/arm-unknown-linux-gnueabi/buildtools/bin/arm-unknown-linux-gnueabi-gcc`



`arm`ç›®å½•æ–°å»ºä¸€ä¸ª`helloworld.c`ç„¶åç¼–è¯‘

![image-20220606134515705](./imgs/image-20220606134515705.png)

```
/home/liuqingshuai/Desktop/cross/x-tools/arm-unknown-linux-gnueabi/arm-unknown-linux-gnueabi/buildtools/bin/arm-unknown-linux-gnueabi-gcc -static hello.c -o hello
```

![image-20220606134503816](./imgs/image-20220606134503816.png)



é‡‡ç”¨å®éªŒ 1 çš„æŒ‚è½½

```
sudo mount -o loop ./rootfs.ext3 /tmp
```

ç„¶åæŠŠè¿™ä¸ª`world`å¯æ‰§è¡Œæ–‡ä»¶ copy åˆ°`tmp`ç›®å½•é‡Œï¼Œå¦‚æœé‡åˆ°æƒé™ä¸å¤Ÿçš„é”™è¯¯ï¼Œåˆ™åœ¨`arm`ç›®å½•ä¸‹æ‰§è¡ŒæŒ‡ä»¤ï¼Œç„¶åå†å¤åˆ¶ï¼ˆä¼šå‡ºç°**è¯»ä¸€è¡Œä»€ä¹ˆç©æ„çš„error**ï¼Œä¸ç”¨ç®¡ï¼‰ï¼Œæƒé™å°±å¤Ÿäº†

```
sudo nautilus
```

ç„¶åå–æ¶ˆæŒ‚è½½

```
sudo umount /tmp
```

`arm`ç›®å½•ä¸‹ä¸‹å¯åŠ¨`arm`æ¨¡æ‹Ÿå™¨

```
qemu-system-arm -M vexpress-a9 -kernel ./zImage -nographic -m 512M -smp 4 -sd ./rootfs.ext3 -dtb vexpress-v2p-ca9.dtb -append "init=/linuxrc root=/dev/mmcblk0 rw rootwait earlyprintk console=ttyAMA0"
```

ç„¶åè¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼ŒæˆåŠŸè¾“å‡º

![image-20220606134619917](./imgs/image-20220606134619917.png)

è‡³æ­¤ï¼Œå®éªŒå®Œäº†

### 2.3å®éªŒç»“æœ

æˆåŠŸç”Ÿæˆäº† `arm` çš„ `gcc` ç¼–è¯‘å·¥å…·ï¼Œå¹¶æˆåŠŸç”Ÿæˆ `arm` å¹³å°ä¸‹å¯æ‰§è¡Œæ–‡ä»¶ï¼ŒåŒæ—¶åœ¨ `qemu` æ¨¡æ‹Ÿå™¨é‡ŒæˆåŠŸæ‰§è¡Œ

## ä¸‰ã€åº”ç”¨ç¨‹åºå¼€å‘  

### 3.1å®éªŒç›®çš„

åˆ©ç”¨å®éªŒä¸€ç¼–è¯‘å‡ºçš„æ“ä½œç³»ç»Ÿå’Œå®éªŒäºŒæ„å»ºçš„ç¼–è¯‘å·¥å…·é“¾ï¼Œå®Œæˆä¸€ä¸ªåŸºäºcè¯­è¨€çš„SHA-1åº”ç”¨ç¨‹åºå¼€å‘ã€‚ ç¼–è¯‘äº§ç”Ÿçš„å¯æ‰§è¡Œæ–‡ä»¶èƒ½åœ¨ qemu ä¸­æ‰§è¡Œã€‚

### 3.2ç®—æ³•æ­¥éª¤

å¯¹äºä»»æ„é•¿åº¦çš„æ˜æ–‡ï¼ŒSHA1é¦–å…ˆå¯¹å…¶è¿›è¡Œåˆ†ç»„ï¼Œä½¿å¾—æ¯ä¸€ç»„çš„é•¿åº¦ä¸º512ä½ï¼Œç„¶åå¯¹è¿™äº›æ˜æ–‡åˆ†ç»„åå¤é‡å¤å¤„ç†ã€‚

å¯¹äºæ¯ä¸ªæ˜æ–‡åˆ†ç»„çš„æ‘˜è¦ç”Ÿæˆè¿‡ç¨‹å¦‚ä¸‹ï¼š

ï¼ˆ1ï¼‰ å°†512ä½çš„æ˜æ–‡åˆ†ç»„åˆ’åˆ†ä¸º16ä¸ªå­æ˜æ–‡åˆ†ç»„ï¼Œæ¯ä¸ªå­æ˜æ–‡åˆ†ç»„ä¸º32ä½ã€‚

ï¼ˆ2ï¼‰ ç”³è¯·5ä¸ª32ä½çš„é“¾æ¥å˜é‡ï¼Œè®°ä¸ºAã€Bã€Cã€Dã€Eã€‚

ï¼ˆ3ï¼‰ 16ä»½å­æ˜æ–‡åˆ†ç»„æ‰©å±•ä¸º80ä»½ã€‚

ï¼ˆ4ï¼‰ 80ä»½å­æ˜æ–‡åˆ†ç»„è¿›è¡Œ4è½®è¿ç®—ã€‚

ï¼ˆ5ï¼‰ é“¾æ¥å˜é‡ä¸åˆå§‹é“¾æ¥å˜é‡è¿›è¡Œæ±‚å’Œè¿ç®—ã€‚

ï¼ˆ6ï¼‰ é“¾æ¥å˜é‡ä½œä¸ºä¸‹ä¸€ä¸ªæ˜æ–‡åˆ†ç»„çš„è¾“å…¥é‡å¤è¿›è¡Œä»¥ä¸Šæ“ä½œã€‚

ï¼ˆ7ï¼‰ æœ€åï¼Œ5ä¸ªé“¾æ¥å˜é‡é‡Œé¢çš„æ•°æ®å°±æ˜¯SHA1æ‘˜è¦ã€‚

:file_cabinet: sha1.c

```c
#include <stdio.h>
#include <stdlib.h>
#define SHA1_ROTL(a,b) (SHA1_tmp=(a),((SHA1_tmp>>(32-b))&(0x7fffffff>>(31-b)))|(SHA1_tmp<<b))
#define SHA1_F(B,C,D,t) ((t<40)?((t<20)?((B&C)|((~B)&D)):(B^C^D)):((t<60)?((B&C)|(B&D)|(C&D)):(B^C^D)))
long SHA1_tmp;
char* StrSHA1(const char* str, long long length, char* sha1){
    /*
    è®¡ç®—å­—ç¬¦ä¸²SHA-1
    å‚æ•°è¯´æ˜ï¼š
    str         å­—ç¬¦ä¸²æŒ‡é’ˆ
    length      å­—ç¬¦ä¸²é•¿åº¦
    sha1         ç”¨äºä¿å­˜SHA-1çš„å­—ç¬¦ä¸²æŒ‡é’ˆ
    è¿”å›å€¼ä¸ºå‚æ•°sha1
    */
    char *pp, *ppend;
    long l, i, K[80], W[80], TEMP, A, B, C, D, E, H0, H1, H2, H3, H4;//Kå’ŒWæ˜¯32ä½çš„æ•°ç»„
    H0 = 0x67452301, H1 = 0xEFCDAB89, H2 = 0x98BADCFE, H3 = 0x10325476, H4 = 0xC3D2E1F0;//åˆå§‹åŒ–å˜é‡
    for (i = 0; i < 20; K[i++] = 0x5A827999);
    for (i = 20; i < 40; K[i++] = 0x6ED9EBA1);
    for (i = 40; i < 60; K[i++] = 0x8F1BBCDC);
    for (i = 60; i < 80; K[i++] = 0xCA62C1D6);
    l = length + ((length % 64 > 56) ? (128 - length % 64) : (64 - length % 64));//l=64
    printf("l=%d\n",l);
    if (!(pp = (char*)malloc((unsigned long)l))) return 0;
    for (i = 0; i < length; pp[i + 3 - 2 * (i % 4)] = str[i], i++);//ä¸ºllehw ,odlro
    for (pp[i + 3 - 2 * (i % 4)] = 128,i++; i < l; pp[i + 3 - 2 * (i % 4)] = 0,i++);
    *((long*)(pp + l - 4)) = length << 3;
    *((long*)(pp + l - 8)) = length >> 29;
    for (ppend = pp + l; pp < ppend; pp += 64){
        for (i = 0; i < 16; W[i] = ((long*)pp)[i], i++);
        for (i = 16; i < 80; W[i] = SHA1_ROTL((W[i - 3] ^ W[i - 8] ^ W[i - 14] ^ W[i - 16]), 1), i++);
        A = H0, B = H1, C = H2, D = H3, E = H4;
        for (i = 0; i < 80; i++){
            TEMP = SHA1_ROTL(A, 5) + SHA1_F(B, C, D, i) + E + W[i] + K[i];
            E = D, D = C, C = SHA1_ROTL(B, 30), B = A, A = TEMP;
        }
        H0 += A, H1 += B, H2 += C, H3 += D, H4 += E;
    }
    free(pp - l);
    sprintf(sha1, "%08X%08X%08X%08X%08X", H0, H1, H2, H3, H4); 
    return sha1;
}

int main(){
  printf("ä½ å¥½\n");
  char sha1[41]={0}; //sha1ç”¨äºä¿å­˜è®¡ç®—ç»“æœ
  StrSHA1("hello, world", 12, sha1); //è®¡ç®—å­—ç¬¦ä¸²â€œhello, worldâ€å‰12ä½çš„sha1
  printf(sha1);
  printf("\n");
}
```

ç»ˆç«¯æ‰§è¡Œ

```
/home/liuqingshuai/Desktop/cross/x-tools/arm-unknown-linux-gnueabi/arm-unknown-linux-gnueabi/buildtools/bin/arm-unknown-linux-gnueabi-gcc -static sha1.c -o sha1Arm
sudo mount -o loop ./rootfs.ext3 /tmp
sudo nautilus
æ‹·è´sha1Armåˆ°tmpç›®å½•
sudo umount /tmp
qemu-system-arm -M vexpress-a9 -kernel ./zImage -nographic -m 512M -smp 4 -sd ./rootfs.ext3 -dtb vexpress-v2p-ca9.dtb -append "init=/linuxrc root=/dev/mmcblk0 rw rootwait earlyprintk console=ttyAMA0"
```

![image-20220614195224598](./imgs/image-20220614195224598.png)

åœ¨ç½‘ç«™ä¸ŠéªŒè¯`hello, world`(ä¸­é—´æœ‰ä¸€ä¸ªç©ºæ ¼)çš„sha1åŠ å¯†ç»“æœï¼Œå‘ç°å®Œå…¨ä¸€æ ·ã€‚

![image-20220614195419640](./imgs/image-20220614195419640.png)

### 3.3å®éªŒç»“æœ

æˆåŠŸå†™äº†ä¸€ä¸ªèƒ½è®¡ç®—`SHA-1`çš„Cè¯­è¨€ç¨‹åºï¼Œå¹¶åˆ©ç”¨è‡ªå·±çš„äº¤å‰ç¼–è¯‘å·¥å…·é“¾ç”Ÿæˆäº†å¯æ‰§è¡Œæ–‡ä»¶ï¼Œåœ¨`qemu`æ¨¡æ‹Ÿå™¨é‡ŒæˆåŠŸæ‰§è¡Œ







å¦‚æœæ‚¨è§‰å¾—æˆ‘å†™çš„ä¸é”™ï¼Œç»™æ‚¨èŠ‚çœäº†æ—¶é—´ï¼Œè°¢è°¢å°±ä¸ç”¨äº†ï¼Œå¯ä»¥ç»™å’±moneyæ”¯æŒğŸ˜

<div align=center>
  <img src="./imgs/image-20220701225923794.png">
  <img src="./imgs/image-20220701225949117.png">
</div>



